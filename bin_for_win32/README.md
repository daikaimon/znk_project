# Moai
-----------------------------------

## <a name="index">目次
-----------------------------------
* [Moaiとは？](#pos1)
* [ローカルプロキシとは？](#what_localproxy)
* [何ができるのか？](#pos2)
* [インストール/アンインストール方法](#pos4)
* [初めてのMoai](#pos5)
* [プロキシ設定ダイアログって何ぞ？](#pos6)
* [同種のツールと比べた場合の特徴](#merit)
* [いっしょに含まれているhttp_decoratorとかZnkとかいうのは何なのか？](#pos7)
* [プログラマではない方へ](#for_not_programmer)
* [プログラマな方へ](#for_programmer)
* [ライセンス](#license)
* [ご注意](#warning)
* [免責事項](#as_is)

## <a name="pos1">Moaiとは？
-----------------------------------

  このツールは一言で言えばHTTPを仲介するローカルプロキシである.
  同種のツールとしてはProxomitronやPolipoなどがあり、これらをご存知の方は
  それと基本的に同じようなものである.

  <a href="#user-content-index">目次へ戻る</a>

## <a name="what_localproxy">ローカルプロキシとは？
-----------------------------------

  通常、プロキシを使う場合、あなたと最終接続先となるホスト以外の第三者である
  プロキシサーバへと接続して通信を仲介させる. 概念的には以下のようになる.

~~~
    ブラウザ <=> 外部サーバのProxyプログラム <=> 接続先サイト
~~~

  これにより、接続先サイトからはあなたのIPアドレスが隠蔽される.

  一方、ローカルプロキシとはそのような第三者となるサーバで仲介するのではなく、
  この仕事を文字通り今あなたの使っているコンピュータ上で行うというものである.
  概念的には以下のようになる.

~~~
    ブラウザ <=> あなたのマシン上で動作するローカルプロキシ <=> 接続先サイト
~~~

  お気づきだと思うが、ローカルプロキシがあくまであなたのマシンで動作している以上、
  接続先サイトから見ればあなたのマシンからの通信となる. つまりIPアドレスは隠蔽されない.
  ローカルプロキシを使う目的は IPアドレスを隠蔽することではないのだ.

  では何のためにこれを間に挟むのか？

  <a href="#user-content-index">目次へ戻る</a>

## <a name="pos2">何ができるのか？
-----------------------------------

  Moaiに限らず、一般にローカルプロキシは、あなたのブラウザとサイトとの通信を仲介する.
  その主たる目的は、あなたが定義したフィルタに従って、その通信内容をフィルタリング
  することである. このフィルタリングの対象となるホストは細かく選択することもできる.
  例えば www.moai-chan.net という掲示板があったとして、そのサイトとの通信を行う場合のみ
  ある種のフィルタリングを行い、その他のサイトに関してはまた別のフィルタを使ったり
  そもそもフィルタリングを行わないといった具合である.

  これによって特定の接続先サイトに送られるあなたのマシン固有の情報を遮断したり
  偽装したりすることができる. つまりローカルプロキシとはプライベートを守るための
  セキュリティーツールであり、それが本来の目的である.

  接続先サイトに送られるこの種の情報とは具体的にはUser-Agent、POST時の変数の内容、
  Cookieの内容などである. あなたが使っているブラウザには特にクリーンアップしない限り
  この種の情報があちこちに残留している. ローカルプロキシのフィルタリングはこれを
  遮断したり加工修正することで接続先サイトにこれらがそのまま送信されることを防ぐ.

  また一方、受信においてサイトからの応答時のデータ(HTMLなど)を加工修正することもでき
  これを応用することで、ページのレイアウトを好みの形に修正したり、広告を除去したり
  することができる. 

  また**config.myf**内の**ignore_hosts**に通信をブロックしたいホストを記述しておくことで
  余計な通信を未然に防ぎ、結果的にあなたが普段よく見るサイトの表示を高速化するなど
  といったこともできる.   

  ブラウザが行う全HTTPを仲介しており、すべての通信内容をあなたへレポートする.  
  このレポートはターミナル(Windowsの場合コマンドプロンプトウィンドウ)において行われ、
  また**moai_log.log**というファイルにログとしても記録される.  

  Moaiに限らず、一般にローカルプロキシは、HTTP CONNECTによるトンネリングにより
  HTTPSを仲介することもできる. 仲介といっても流れて来たデータをただそのまま通すだけなのだが
  これが意外と難しかったりする. Moaiもこれをサポートしており、Google検索やYoutube、
  nico動画などを見ることも可能である.

  <a href="#user-content-index">目次へ戻る</a>

## <a name="pos4">インストール/アンインストール方法
-----------------------------------

  特にない. 
  同様にアンインストールのための特別な手順もない.
  レジストリなどへの書き込みやこのフォルダ配下以外への一時ファイルの作成などは一切行われない.
  不必要になったらこのフォルダ毎削除すればよい.

  ただ、Windowsであればmoai.exeのショートカットを作り、デスクトップに置いておけば
  より快適であろう.

  このツールはLinuxでも動作し、Linux用の実行用バイナリも一応同梱してあるが、
  ディストリビューションやそのライブラリのバージョン構成によっては動作しないということも有り得る.  
  必要なら[HowToCompile.md][3]を見てもらいソースコードからコンパイルして戴きたい. 
  (Moaiのソースコードは src/moaiにある).

  <a href="#user-content-index">目次へ戻る</a>

## <a name="pos5">初めてのMoai
-----------------------------------

  初めてMoaiを使う場合は、以下の手順で設定しよう.

~~~
  1. moai(Windowsならmoai.exe)を起動する.

  2. ブラウザのプロキシ設定ダイアログでプロキシサーバとして localhost:8124 を指定する.
     これでうまくいかない場合は 127.0.0.1:8124 で試してみよう! 
     これは一般にループバック接続と呼ばれ、自分自身への接続を意味する.
     リモートホストで起動しているMoaiに接続したい場合はそのIPを指定してもよい.

  3. ブラウザから目的のサイトへアクセスできればOKである.
     さらに127.0.0.1:8124にアクセスし、Welcome to Moai Web Serverのページが表示されることを確認しよう.
~~~

  基本的には以上である.

  もし「プロキシサーバへの接続を拒否されました」のような表示がなされた場合は
  おそらく 1 を起動していないか 2 の手順で何か指定をミスしている.  
  あるいはOSのファイアウォール機能により8124への接続がブロックされている可能性もあるので
  その設定を確認してみよう.  

  Windows XP以降の場合、次のようなダイアログが表示される場合がある.  
  ![screenshot](../imgs/screenshot_warning_on_win32.png)

  ここで「ブロックする」を選んでも、このツールをローカルプロキシとして使う分には特に問題ない.  
  ただ、他のLAN上のマシンなどからの利用をしたい場合は、このブロックを解除する必要がある.

  **【参考】**
~~~
    このダイアログは一体何なのか？  

    少し詳しく述べると、サーバのような外部のマシンからの接続要求の可能性があるプログラムにおいて
	初回起動時に必ず表示されるものである.  この種のプログラムを過去にインストールしたことがある方なら
	見たことがあるという方も多いのではないだろうか？
  
    さらにプログラマの方向けの話になるが、このダイアログは INADDR_ANYを指定してWinSock2 APIでの
    bind を実行すると表示される.
~~~

  Moaiは簡易Webサーバとしても機能する.  
  Moaiが起動している状態でブラウザのURL指定欄に http://localhost:8124 または http://127.0.0.1:8124 を
  指定してアクセスした場合、Welcome to Moai Web Serverといったようなページが表示される.
  ここからdoc_rootにあるファイルにアクセスしたり、Moai Web Configuration画面などを出して設定などを
  行うことができる.  

  Moai Web Topページ  
  ![screenshot](../imgs/screenshot_top.png)

  Moai Web Configuration  
  ![screenshot](../imgs/screenshot_config.png)

  <a href="#user-content-index">目次へ戻る</a>

## <a name="pos6">プロキシ設定ダイアログって何ぞ？
-----------------------------------

  プロキシを使ったことがある方なら、この項目を読む必要はない.
  **使ったことありまへぇん**な方でも、プロキシの設定方法に関してはググればいくらでも
  出てくるのでそちらをご覧戴きたいが、それで片付けるのもなんなので、以下では初心者の方
  向けにFirefoxを例にとって具体的な設定方法を一応説明する.

~~~
  1. 「ツール」メニューから「オプション」を選び、例の色々設定できる画面を開く.
  2. 「詳細」タブを選び、そこにある「接続設定」ボタンを押す.
  3. 「インターネット接続」ダイアログ(下図)が出るので「手動でプロキシを設定する」
      という部分にチェックをつける.
  4.  すぐ下にある「HTTPプロキシ」の部分に localhost (または127.0.0.1) と入力する.
      また右隣にある「ポート」の部分に 8124 と入力する(このとき日本語入力はOFFにしておこう!)
  5.  同様にその下にある「SSLプロキシ」の部分に localhost (または127.0.0.1) と入力する.
      また右隣にある「ポート」の部分に 8124 と入力する(このとき日本語入力はOFFにしておこう!)
  6.  moaiを起動する.  
~~~
  以上である(先にmoaiを起動させておいてもよい).

  ![screenshot](../imgs/screenshot_proxy_dialog.png)


  **【重要】**  
  元の設定に戻す(プロキシを使用しない)方法も覚えておこう.
  上記 3. において「プロキシを使用しない」という項目が一番上にある.
  これにチェックをつけることで、Firefoxはプロキシを介さない通常の状態に戻る.
  (Firefoxの初期設定では元々この状態のはずである)

  もしmoaiの方が何か変なことになった場合は、一度moaiを終了して再び起動させれば
  大抵の場合は問題は解消される. 万一閲覧しているサイトがどうしてもmoaiを介した場合に
  うまく表示されないなど不具合が発生する場合は、ブラウザのプロキシ設定を元に戻した上で閲覧しよう.

  <a href="#user-content-index">目次へ戻る</a>

## <a name="merit">同種のツールと比べた場合の特徴
-----------------------------------

  Moaiは完全なオープンソースであり、ライセンスは多分これ以上ないくらいに緩い.
  この種の処理を実現するためのコードとしては同種のものと比べかなりコンパクトで
  必要最小限に絞られており見通しが立ちやすい. またこれにより、未知の不具合により
  潜在的なセキュリティーホールを含むリスクを抑えられる. 
  コードはCで記述されており、外部のライブラリは基本ライブラリであるZnk(これも
  オープンソースでNYSLである)を除き使っていないため、問題発生時に追跡がしやすい.
  コンパイルが容易でWindowsやLinuxで動作する(未確認だがMacOSでも多分大した修正なく
  いけるだろう).

  Moaiの提供する機能は同種のツールであるProxomitronやPolipoなどと比べ、
  機能はずっと限定されるため、普段これらを使いこなしている方にとっては
  これは不要かもしれない. しかしPOST変数に関するフィルタリングに関しては
  ProxomitronとPolipoはいずれも直接はサポートしておらず、それを実現するには
  外部ツールを使う必要があるなどやや煩雑になる. 対してMoaiはフィルタファイルにより
  これがダイレクトかつ容易に設定できるため、その点では有利である. 
  また掲示板投稿時の際、その内容をフィルタリングしたり、その内容を解析するのに
  Moaiは最適である.
  MoaiはPolipoなどと同様にSocket通信における非ブロッキング接続やHTTPパイプライン化を
  サポートする. これにより複数のタブを開いてWebを閲覧する場合に、接続の早く完了した
  ものから順に表示するなど、ブロッキングが発生することなく快適な閲覧が可能である.

  ネットワークが特別混雑していない限りは、それほどストレスを感じることもないと思う.
  動画サイトなど大量にデータを扱うサイトであっても通常は大丈夫だろう.

  <a href="#user-content-index">目次へ戻る</a>

## <a name="pos7">いっしょに含まれているhttp_decoratorとかZnkとかいうのは何なのか？
-----------------------------------

  Moaiは我々のボスであるMr.Moai氏が開発したローカルプロキシエンジンであり、このツール群のまさに中核である.
  また、http_decoratorは我々の**飲み仲間**である DecoDecoBoy氏が**酔った勢いで**即興で書いた簡易HTTPクライアントであり、
  必要に応じて内部で呼び出されることがある.
  libZnkは我々日本HTTP研究所(NHK)のふたば/２ちゃんねる地区担当のエージェントZenkakuが開発したライブラリで
  上記のC言語で記述を支援するためのものである. そのため、これらがこのフォルダに含まれる.

  Moaiはブラウザのクッキーやキャッシュなどを実際に消去したり、あなたのモニタの解像度を実際に変更したり
  などといったことは勿論行わない. そうではなく通信の仲介役であるMoaiのフィルタを変更することによって、
  サイトへと送られる情報を改変し、そのような状況を仮想的にシミュレートしている.

  またfiltersやpluginsには、Moaiのフィルタや機能拡張のためのモジュールが格納されている.
  Moai自体はどこのサイト専用というわけではなく、あらゆるサイトに使うことができる汎用のツールである.
  MoaiのVirtual USERS機能は、Moaiのフィルタやプラグイン機能を使って( 現時点ではfutabaまたは2ちゃんねる
  向けの )モジュールを追加しており、Moaiは単にそれを読み込んで動作している形となる. 
  必要なら新たなサイト向けのフィルタやプラグインをあなたが新しく作ってMoaiの機能を拡張することも可能だ.

  <a href="#user-content-index">目次へ戻る</a>

## <a name="for_not_programmer">プログラマではない方へ
-----------------------------------

  一応、すぐに使えるようにWindows用とLinux用の実行バイナリが同梱してある.
  インストール等特別な作業は不要である.

  しかし、このツールが安全であるという確証がなければ安心して使えないという方もおられよう.
  残念ながら「いくらこれは安全です」と作者である我々が言ったところでほとんど何の確証にも
  ならない. あなたの良く知る友人が言うなら少しは信用できるかもしれないが、これに関する
  唯一確実な方法は、ソースコードを見て納得してもらう他ない. というわけで全ソースコードも
  同梱してある.

  とはいえ、我々プログラマでさえ、オープンソースのツールを使うとき、そのコードの隅々まで
  読んでから使うなど稀なことである. ましてやプログラマでもない方にこれをせよというのは
  酷というものである.
  
  ではどうすればよいか？
  ソースコードが公開されている事実だけでよしとして、それ以上は気にしないというのも一つの
  考え方である. 一方、その内容を一応検査してから使いたいという慎重派な方は、あなたに
  プログラミングに詳しい知り合いがいるなら、このソースコードをざっくりとチェックして
  もらうのもよい. そんな知り合いはいない方はプログラミングを扱う掲示板などでこのツールの
  ソースコードをアップロードするなどして意見を聞き、あなたなりの納得を得るのもよいかもしれない.

  さらに潔癖な方は、付属するソースコードをコンパイルしてそれを使用することを勧める. 
  機械的な作業なので言うほど難しくはない(…と我々は思うのだが…).
  もちろん同梱してある実行バイナリは、同じく同梱してあるソースコードからコンパイルしたもの
  なのであるが、例えばあなたがそのことを疑って、本当にそうであるという確証が欲しいと思った
  とする. そのためには、あなた自身が同梱してあるソースコードをコンパイルし、出来上がった
  実行バイナリを使ってもらうしかない.

  というわけで付属のHowToCompile.txtにはコンパイラの入手方法、インストール/設定方法、
  実行方法に至るまで、全くの初心者でもわかるようこれでもかというくらい丁寧にその手順を
  書いたつもりである.

  <a href="#user-content-index">目次へ戻る</a>

## <a name="for_programmer">プログラマな方へ
-----------------------------------

  ここでは開発言語としてCを使ってある.
  そして今回リリースしたバージョンでは実行効率より確実性を最優先にしてある.

  C++ならばもっと記述は簡潔になる部分もあろうが、それは同時に事実上のブラックボックス
  となる処理の割合が高くなることも意味する. 特にコンストラクタやデストラクタの発動の
  タイミングやコンパイラ依存の差異や癖などですら、デバッガでも追跡困難なバグを誘発する.
  というわけで我々はどうでもいい開発にはC++を使うこともあるがそうではない場合はC++は
  基本的に使わない.
  ちなみに基本ライブラリであるlibZnkはC/C++いずれからでも使用可能である.

  その他メジャーなスクリプト言語(rubyやpythonなど)は大抵の場合良い選択だが、
  インタプリタや付属ライブラリのバージョンアップなどで、今まで問題なく動作していたものが
  突然エラーになるなどよくある話ではある. また万一その言語に未知のバグがあったり
  ドキュメントされていないある種の癖に由来した不具合が発生した場合、スクリプト環境
  に付属した膨大なコードから原因を探すなどやってられないので今回は不採用とした.

  このツールは改造もしやすいと思う. 技術のある方は是非挑戦してもらいたい. 
  (特にMacOSへの対応は大いに歓迎する). 勿論あなたが書くのだからお好きな言語で
  書きなおしてもらってもいい. そして改造したものを是非とも公開して戴ければ我々に
  とってこれ以上の喜びはない(ソースコード公開の義務など微塵もないが、上に書いてある通り
  公開した方がより多くの人に使ってもらえる確率は高くなると思う). 

  ところでPolipoもCで記述されたオープンソースであり、実のところ当初はこれを改造して
  Lolipo(失礼ｗ)というツールでリリースする予定でいたのだが、Polipoのコードは関数名や
  グローバル変数名の命名規則や、それらの依存関係があまりに汚かった(失礼ｗ)ので、
  今回Moaiという新しいツールをフルスクラッチで開発する方が早いという結論に至った. 
  とはいえPolipoは非常に優れたツールであり、多くの部分を参考にさせてもらった.
  Juliusz Chroboczek氏には感謝する. ポート番号8123はPolipoで使われていたものであり、
  それに敬意を表しMoaiではこれのお隣という意味で8124をデフォルトポートとした.

  <a href="#user-content-index">目次へ戻る</a>

## <a name="license">ライセンス
-----------------------------------

  NYSL(煮るなり焼くなり好きにしろ)である.  
  ( NYSLについては http://www.kmonos.net/nysl を参照. )  
  現時点での公式のソースリポジトリは https://github.com/mr-moai-2016/znk_project であるが
  再配布はご自由にどうぞ.

  <a href="#user-content-index">目次へ戻る</a>

## <a name="warning">ご注意
-----------------------------------

  Moaiは生まれたばかりのローカルプロキシです.
  特に重要な内容を伴う情報の通信を確実に行う必要がある場合においては、
  まず問題ないとは思うが、念のためMoaiの使用を一時中断するなどした方がよいかもしれない. 

  また、このプログラムはポート番号8124においてクライアントからの接続をリッスンする.
  (このデフォルトのポート番号はconfig.myfより変更することもできるが、その場合は
   8124をその番号で読み替えて欲しい). 
  ここで言う「クライアント」とは、あなたのマシン、あるいは家庭内LANなど極めて小規模で
  安全性が明らかなマシンにおいて、あなたの使うWebブラウザやその他のローカルプロキシ
  などのソフトなどのことである. Moaiはローカルプロキシの名が示す通り、外部ネットワーク
  (WAN)からの不特定多数からの接続に関してはIPアドレスによる最低限の防御機構を備えてはいるが
  本格的な攻撃に対する防御はほとんど考慮されていない. 

  よってあなたがルータの設定を特別弄くっていない限りは通常は心配いらないことであるが、
  acceptable_hostをANYとして、さらにルータやファイアウォールの8124ポートを開けているなど
  WANからの接続が可能となってしまうようなケースについては、Moai側での防御としては
  access_allow_ips や access_deny_ips などを適切に設定するなど、安全面に十分配慮して欲しい.

  <a href="#user-content-index">目次へ戻る</a>

## <a name="as_is">免責事項
-----------------------------------

  本ソフトウェアは「現状のまま」で、明示であるか暗黙であるかを問わず、
  何らの保証もなく提供されます. 本ソフトウェアの使用によって生じるいかなる損害についても、
  作者は一切の責任を負わないものとします.

  This software is provided 'as-is', without any express or implied warranty.
  In no event will the authors be held liable for any damages arising
  from the use of this software.

  <a href="#user-content-index">目次へ戻る</a>

[3]: https://github.com/mr-moai-2016/znk_project/blob/master/src/HowToCompile.md

# Moai/Virtual USERS
-----------------------------------

## 目次
-----------------------------------
* [MoaiのVirtual USERS機能とは？](#pos1)
* [何ができるのか？](#pos2)
* [Web閲覧時に送信される情報とは何なのか？](#pos3)
* [MoaiのVirtual USERS機能を使う](#pos5)
* [その他の情報](#pos8)

## <a name="pos1">MoaiのVirtual USERS機能とは？
-----------------------------------

  Virtual USERSとはVirtual User-agent Screen-size and Everything Randomize Systemの略である.
  この記事ではMoaiのVirtual USERS機能について特に詳しく述べる.

  ネット上のサイトはあらゆる側面からあなたのマシン固有の情報を集め、あなた個人を識別しようと試みる.  
  Virtual USERS機能はブラウザと送信先のサイトとの通信を仲介し、IPを除くそれら全ての情報に関して、
  あなたの実際のマシン環境とは異なるバーチャルかつランダムな値へ変更した上でサイトへと送る.  
  これにより送信先はあなたを正しく識別できなくなる.  
  つまり早い話、これはよくあるあなたのプライベートを守るセキュリティーツールの一つである.  


## <a name="pos2">何ができるのか？
-----------------------------------

  Virtual USERS機能はIPを除くすべてのあなたのマシンの情報をランダムに仮想化する.
  これに踏まえ、ルーカチ(ルータリセット)などによりIPを変えることで、掲示板などにおいて
  完全に別のユーザに生まれ変わることができるというものである.

  また、場合によってはブラウザのCookieやJavascriptを無効にした状態でも掲示板にレス出来るという
  ほとんどの方にとって極めてどうでもよい副次的効果もある.  

  また **parent_proxy.txt** に使用したいプロキシの候補を複数列挙しておくことで、
  Moai Web Configuration上でこれらのプロキシがメニュー表示され、現在使用するプロキシを簡単かつ
  瞬時に切り替えができる.  


## <a name="pos3">Web閲覧時に送信される情報とは何なのか？
-----------------------------------

  以下の概念図を見てみよう.  

~~~
                          HTTPヘッダ
  あなたのブラウザ環境 === POST変数     ===> 送信先のサイト
                          クッキー
~~~

  これは一般に送信先サイトへ実際に何が送信されるかを示したものである.  
  送信先のサイトへはあなたのマシン固有の様々な情報が送信されるのであるが、
  それらはIPを除けばダイレクトに送信されるわけではなく、すべて上記にある３つの
  うちのいずれかの範疇にまずパックされて送信されるということだ.  
  (厳密に言えばクッキーも最終的にHTTPヘッダの範疇になるが、ここでは別枠とした)  

  たとえばふたばを例にとった場合、送信されるあなたのマシン情報とは

~~~
  1. IP  
    通常、プロバイダが割り当てたあなたの動的なIPアドレスである.  
    その場合、ルーカチ(以下、ルータのリセットの意味でこの言葉を使う)でこの値を
    変更可能である. その他、外部プロキシ、VPNを用いた場合はそのIPとなる.  

  2. User-Agent  
    簡単に言えば、あなたの使っているブラウザの識別名である.  
    この値はHTTPヘッダに格納された形で送信される.  

  3. posttimeおよびそれに類したふたばより発行される値  
    この値はふたばに初アクセスした時間(およびそれに類した値)である. 現状では
    カタログに初めてアクセスするか、または初めてレス投稿した際に設定されるようである.
    あるいは /bin/cachemt7.php にアクセスしたときにそれに類した値が生成される形となる.
    一旦設定されると、CookieおよびブラウザキャッシュおよびlocalStorage これら全てを
    消去しない限り同じ値が残り続ける. この値はPOST変数 pthb, pthc, (pthd) とCookieの
    posttime値として送信される.  

  4. SCreenSiZe  
    簡単に言えば、あなたの使っているモニタの解像度と色深度の情報である.
    (Javascriptにこれを取得するAPIがあり、これを利用しているようである)
    この値はPOST変数 scsz として送信される.  

  5. Fingerprint  
    この値はあなたのマシン環境の様々な情報を集めて文字列とし、それを元に32bit整数の
    ハッシュ値を計算したものである.この値はPOST変数 flrv, flvv として送信される.

    ハッシュ値が何のことかわからない方は、次のように考えればよい.
    例えばあなたのマシンの特徴を示す情報が３つあったとしてそれをそれぞれ仮に
    数字の 2, 4, 7 とする. これらを足し算して合計すると 2 + 4 + 7 = 13 となるが、
    この 13 がハッシュ値に相当しここではこれが送信される. 非常に大雑把だが、
    とりあえずそのようなイメージで十分である.

    ここでのポイントは 13 から元の値 2, 4, 7 を一意には復元できないということである.
    よってこの値は実のところデタラメに設定しても一般にその妥当性を検証する術はない.  
~~~

  お分かり戴けただろうか？  
  繰り返しになるが、上記はIPを除けば最終的にはHTTPヘッダ、POST変数、そしてCookieの値の
  いずれかとして送信される. そしてあなたがもし、そのとき送信されるこれらHTTPヘッダや
  POST変数やCookieを直接修正する術を持つなら、上記の値はすべて(ブラウザやモニタの解像度
  などのマシン環境を実際に変更することなく)自由に仮想環境を構築可能であるということだ.

  では具体的にどうやって仮想環境を構築するのか？
  実のところこれは手動でも可能であるし、プログラミングするにしてもそう難しい話でもないが
  MoaiのVirtual USERS機能ならばそれをすべて自動で行うことができ、楽ができる.


## <a name="pos5">MoaiのVirtual USERS機能を使う
-----------------------------------

  初めてMoaiを使う場合は、[こちら][2]にある「初めてのMoai」の項目を参照していただきたい.

  繰り返しになるが、Moaiが起動している間は、あなたのマシン本来の姿がIPを除いて完全に隠蔽され、
  架空のマシン環境情報を送信する.   これによりブラウザのCookieやJavascriptを無効にしたまま
  掲示板などを閲覧することは勿論、レスやスレ立てをすることすら可能となり、非常にセキュアだ.  

> 現在デフォルトで仮想環境の構築をサポートしているサイトはふたばと２ちゃんねるのみである.
> その他のサイトも当然閲覧は可能だが、仮想環境の構築まで行うには、そのサイト向けの
> filterやpluginを作成して追加しなければならない.

  さて、Virtual USERSの機能に加え、ルーカチ(ルータリセット)などによりIPを変えることで、
  掲示板などにおいて完全に別のユーザに生まれ変わるには次のようにする.

~~~
  1. IPを変えるためルーカチする.
     (あるいは同目的で外部プロキシを変えるなどしてもよい)

  2. moai(Windowsならmoai.exe)を起動し、
     ブラウザからhttp://127.0.0.1:8124へアクセスする.

  3. Moai Web Configuration画面を開き、「Virtual USERS Initiation」ボタンを押す.
    「Initiate futaba : Success : Virtual USERS done. Your futaba_send.myf is randomized successfully.」
     などと表示されれば成功である. 
~~~

  以上である.  

  また、使用する外部プロキシを異なるものに切り替えるには次のようにする.

~~~
  1. moaiを起動した状態で、ブラウザからhttp://127.0.0.1:8124へアクセスする.

  2. Web Configuration画面を開き、parent_proxyから使用する外部プロキシを選んで「Update」ボタンを押す.
     (IPを外部プロキシのものに変える)
     このとき外部プロキシのリストを前もってparent_proxy.txtに記述しておかなければならない.

  3. Web Configuration画面より「Virtual USERS Initiation」ボタンを押す.
    「Initiate futaba : Success : Virtual USERS done. Your futaba_send.myf is randomized successfully.」
     などと表示されれば成功である. 
    「Initiate futaba : Failure : Cannot get ...」などと表示された場合は失敗であり、
     おそらく 2 で指定したプロキシサーバが無効であるか回線が混雑しているなどのため、通信に失敗している.
~~~

  以上である.  


## <a name="pos8">その他の情報
-----------------------------------

  Moaiに関する基本事項や注意事項に関しては、src/moaiにある[README][2]を参照して戴きたい.
  Moaiに関するさらなる詳細については [リファレンスマニュアル(README_more.md)][1] をご覧いただきたい.


[1]: https://github.com/mr-moai-2016/znk_project/blob/master/src/virtual_users/README_more.md
[2]: https://github.com/mr-moai-2016/znk_project/blob/master/src/moai/README.md
[3]: https://github.com/mr-moai-2016/znk_project/blob/master/src/HowToCompile.md

# Moai/Virtual USERS
-----------------------------------

## 目次
-----------------------------------
* [Moai/Virtual USERSとは？](#pos1)
* [何ができるのか？](#pos2)
* [Web閲覧時に送信される情報とは何なのか？](#pos3)
* [インストール/アンインストール方法](#pos4)
* [Moai/Virtual USERSの使い方](#pos5)
* [プロキシ設定ダイアログって何ぞ？](#pos6)
* [いっしょに含まれているmoaiとかhttp_decoratorとかZnkとかいうのは何なのか？](#pos7)
* [さらなる詳細](#pos8)
* [ライセンス](#pos9)
* [ご注意](#pos10)
* [免責事項](#pos11)

## <a name="pos1">Moai/Virtual USERSとは？
-----------------------------------

  USERS とは User-agent Screen-size and Everything Randomize Systemの略である.

  ネット上のサイトはあらゆる側面からあなたのマシン固有の情報を集め、あなた個人を識別しようと試みる.  
  Moai/Virtual USERSはブラウザと送信先のサイトとの通信を仲介し、IPを除くそれら全ての情報に関して、
  あなたの実際のマシン環境とは異なるバーチャルかつランダムな値へ変更した上でサイトへと送る.  
  これにより送信先はあなたを正しく識別できなくなる.  
  つまり早い話、これはよくあるあなたのプライベートを守るセキュリティーツールの一つである.  


## <a name="pos2">何ができるのか？
-----------------------------------

  これによりあなたはある種のネット上においては完全に別人として生まれ変わることが出来る.  
  また、場合によってはブラウザのCookieやJavascriptを無効にした状態でも掲示板にレス出来るという
  ほとんどの方にとって極めてどうでもよい副次的効果もある.  
  また**config.myf**内の**ignore_hosts**に通信をブロックしたいホストを記述しておくことで
  余計な通信を未然に防ぎ、結果的にあなたが普段よく見るサイトの表示を高速化するなど
  といったこともできる.   
  同じく**config.myf**内の**parent_proxy_list**に使用したいプロキシの候補を複数列挙しておくことで、
  Moai Web Configuration上でこれらのプロキシがメニュー表示され、現在使用するプロキシを簡単かつ
  瞬時に切り替えができる.  
  ブラウザが行う全HTTPを仲介しており、すべての通信内容をあなたへレポートする.  
  このレポートはターミナル(Windowsの場合コマンドプロンプトウィンドウ)において行われ、
  また**moai_log.log**というファイルにログとしても記録される.  


## <a name="pos3">Web閲覧時に送信される情報とは何なのか？
-----------------------------------

  以下の概念図を見てみよう.  

~~~
                          HTTPヘッダ
  あなたのブラウザ環境 === POST変数     ===> 送信先のサイト
                          クッキー
~~~

  これは一般に送信先サイトへ実際に何が送信されるかを示したものである.  
  送信先のサイトへはあなたのマシン固有の様々な情報が送信されるのであるが、
  それらはIPを除けばダイレクトに送信されるわけではなく、すべて上記にある３つの
  うちのいずれかの範疇にまずパックされて送信されるということだ.  
  (厳密に言えばクッキーも最終的にHTTPヘッダの範疇になるが、ここでは別枠とした)  

  たとえばふたばを例にとった場合、送信されるあなたのマシン情報とは

~~~
  1. IP  
    通常、プロバイダが割り当てたあなたの動的なIPアドレスである.  
    その場合、ルーカチ(以下、ルータのリセットの意味でこの言葉を使う)でこの値を
    変更可能である. その他、外部プロキシ、VPNを用いた場合はそのIPとなる.  

  2. User-Agent  
    簡単に言えば、あなたの使っているブラウザの識別名である.  
    この値はHTTPヘッダに格納された形で送信される.  

  3. posttimeおよびそれに類したふたばより発行される値  
    この値はふたばに初アクセスした時間(およびそれに類した値)である. 現状では
    カタログに初めてアクセスするか、または初めてレス投稿した際に設定されるようである.
    あるいは /bin/cachemt7.php にアクセスしたときにそれに類した値が生成される形となる.
    一旦設定されると、CookieおよびブラウザキャッシュおよびlocalStorage これら全てを
    消去しない限り同じ値が残り続ける. この値はPOST変数 pthb, pthc, (pthd) とCookieの
    posttime値として送信される.  

  4. SCreenSiZe  
    簡単に言えば、あなたの使っているモニタの解像度と色深度の情報である.
    (Javascriptにこれを取得するAPIがあり、これを利用しているようである)
    この値はPOST変数 scsz として送信される.  

  5. Fingerprint  
    この値はあなたのマシン環境の様々な情報を集めて文字列とし、それを元に32bit整数の
    ハッシュ値を計算したものである.この値はPOST変数 flrv, flvv として送信される.

    ハッシュ値が何のことかわからない方は、次のように考えればよい.
    例えばあなたのマシンの特徴を示す情報が３つあったとしてそれをそれぞれ仮に
    数字の 2, 4, 7 とする. これらを足し算して合計すると 2 + 4 + 7 = 13 となるが、
    この 13 がハッシュ値に相当しここではこれが送信される. 非常に大雑把だが、
    とりあえずそのようなイメージで十分である.

    ここでのポイントは 13 から元の値 2, 4, 7 を一意には復元できないということである.
    よってこの値は実のところデタラメに設定しても一般にその妥当性を検証する術はない.  
~~~

  お分かり戴けただろうか？  
  繰り返しになるが、上記はIPを除けば最終的にはHTTPヘッダ、POST変数、そしてCookieの値の
  いずれかとして送信される. そしてあなたがもし、そのとき送信されるこれらHTTPヘッダや
  POST変数やCookieを直接修正する術を持つなら、上記の値はすべて(ブラウザやモニタの解像度
  などのマシン環境を実際に変更することなく)自由に仮想環境を構築可能であるということだ.

  では具体的にどうやって仮想環境を構築するのか？
  実のところこれは手動でも可能であるし、プログラミングするにしてもそう難しい話でもないが
  Moai/Virtual USERSならばそれをすべて自動で行うことができ、楽ができる.


## <a name="pos4">インストール/アンインストール方法
-----------------------------------

  特にない.  
  同様にアンインストールのために特別必要なこともない.  
  レジストリなどへの書き込みやこのフォルダ配下以外への一時ファイルの作成などは一切行われない.  
  不必要になったらこのフォルダ毎削除すればよい.  

  ただ、Windowsであればvirtual_users.exeのショートカットなどを作り、デスクトップに置いておけば
  いつでも起動しやすくなりより快適であろう. これをさらにスタートアップに登録することで
  Windows起動時に自動的にこれが起動するように設定することもできる.  
  このツールはLinuxでも動作し、Linux用の実行用バイナリも一応同梱してあるが、
  ディストリビューションやそのライブラリのバージョン構成によっては動作しないということも有り得る.  
  必要なら[HowToCompile.md][3]を見てもらいソースコードからコンパイルして戴きたい. 
  (Virtual USERSのソースコードは src/virtual_usersにある).


## <a name="pos5">Moai/Virtual USERSの使い方
-----------------------------------

  まず初めてMoai/Virtual USERSを使う場合は、以下の手順でサイトへアクセスできるかを確認しよう.

~~~
  1. virtual_users(Windowsならvirtual_users.exe)を起動する.

  2. ブラウザのプロキシ設定ダイアログでプロキシサーバとして localhost:8124 を指定する.
    (これでうまくいかない場合は 127.0.0.1:8124 で試してみよう!) 
    これは一般にループバック接続と呼ばれ、自分自身への接続を意味する.

  3. ブラウザから目的のサイトへアクセス！
~~~


  これで目的のサイトが無事表示されれば成功である.

  Moai/Virtual USERSが起動している間は、あなたのマシン本来の姿がIPを除いて完全に隠蔽され、
  架空のマシン環境情報を送信する.   これによりブラウザのCookieやJavascriptを無効にしたまま
  掲示板などを閲覧することは勿論、レスやスレ立てをすることすら可能となり、非常にセキュアだ.  

> 現在デフォルトで仮想環境の構築をサポートしているサイトはふたばのみである.
> その他のサイトも一応閲覧は可能だが、仮想環境の構築まで行うには、そのサイト向けの
> filterやpluginを作成して追加しなければならない.

  もし「プロキシサーバへの接続を拒否されました」のような表示がなされた場合は
  おそらく 1 を起動していないか 2 の手順で何か指定をミスしている.  
  あるいはOSのファイアウォール機能により8124への接続がブロックされている可能性もあるので
  その設定を確認してみよう.  

  Windows XP以降の場合、次のようなダイアログが表示される場合がある.  
  ![screenshot](../imgs/screenshot_warning_on_win32.png)

  ここで「ブロックする」を選んでも、このツールをローカルプロキシとして使う分には特に問題ない.  
  ただ、下記に述べる簡易Webサーバとしてこのツールを使う場合で、かつ他のLAN上のマシンからの接続をしたい場合は、
  このブロックを解除する必要がある.

  **【参考】**
~~~
    このダイアログは一体何なのか？  

    少し詳しく述べると、サーバのような外部のマシンからの接続要求の可能性があるプログラムにおいて
	初回起動時に必ず表示されるものである.  この種のプログラムを過去にインストールしたことがある方なら
	見たことがあるという方も多いのではないだろうか？  また表示にMoai for Windowsとあるが、これは
	Moai/Virtual USERSが内部で使用しているローカルプロキシエンジンであり、サーバとしての仕事は実際には
	このMoaiが行う.
  
    さらにプログラマの方向けの話になるが、このダイアログは INADDR_ANYを指定してWinSock2 APIでの
    bind を実行すると表示される. (MoaiのVer0.8ではこの指定を行っていなかったため、このダイアログは
    表示されなかったが Ver0.9より、LAN間での通信もサポートするため、この指定をデフォルトとした)
~~~

  さて、ルーカチ(ルータリセット)により別人に生まれ変わるには次のようにする.

~~~
  1. ルーカチする(IPを変える).  

  2. virtual_users(Windowsならvirtual_users.exe)を起動し、
     ブラウザからhttp://localhost:8124/configへアクセスする.

  3. Web Configuration画面より「Initiate Targets」ボタンを押す.
    「Initiate futaba : Success : Virtual USERS done. Your futaba_send.myf is randomized successfully.」
     と表示されれば成功である. 
~~~

  以上である.  

  また、外部プロキシを使うことにより別人に生まれ変わる方法もある.
  これは次のようにして行う.

~~~
  1. virtual_users(Windowsならvirtual_users.exe)を起動し、
     ブラウザからhttp://localhost:8124/configへアクセスする.

  2. Web Configuration画面より parent_proxyから使用する外部プロキシを選んで「Update」ボタンを押す.
     (IPを外部プロキシのものに変える)
     このとき外部プロキシのリストを前もってconfig.myf内のparent_proxy_listに記述しておかなければならない.

  3. Web Configuration画面より「Initiate Targets」ボタンを押す.
    「Initiate futaba : Success : Virtual USERS done. Your futaba_send.myf is randomized successfully.」
     と表示されれば成功である. 
    「Initiate futaba : Failure : Cannot get ...」などと表示された場合は失敗であり、
     おそらく 2 で指定したプロキシサーバが無効であるか回線が混雑しているなどのため、通信に失敗している.
~~~

  以上である.  

  Moai/Virtual USERSは簡易Webサーバとしても機能する.  

  ブラウザのURL指定欄に http://localhost:8124 または http://127.0.0.1:8124 を指定してアクセスしてみよう.  
  このような指定は本来「サーバへの接続を確立できませんでした」といったエラーメッセージをブラウザが
  出すはずであるが、Moai/Virtual USERSが起動している場合、Welcome to Moai Web Serverといったようなページが
  表示されるはずである.   ここからdoc_rootにあるファイルにアクセスしたり、Moai Web Configuration画面などを
  出すことができる.  

  Moai Web Topページ  
  ![screenshot](../imgs/screenshot_top.png)

  Moai Web Configuration  
  ![screenshot](../imgs/screenshot_config.png)



## <a name="pos6">プロキシ設定ダイアログって何ぞ？
-----------------------------------

  プロキシを使ったことがある方なら、この項目を読む必要はない.
  **使ったことありまへぇん**な方でも、プロキシの設定方法に関してはググればいくらでも
  出てくるのでそちらをご覧戴きたいが、それで片付けるのもなんなので、以下では初心者の方
  向けにFirefoxを例にとって具体的な設定方法を一応説明する.

~~~
  1. 「ツール」メニューから「オプション」を選び、例の色々設定できる画面を開く.
  2. 「詳細」タブを選び、そこにある「接続設定」ボタンを押す.
  3. 「インターネット接続」ダイアログ(下図)が出るので「手動でプロキシを設定する」
      という部分にチェックをつける.
  4.  すぐ下にある「HTTPプロキシ」の部分に localhost (または127.0.0.1) と入力する.
      また右隣にある「ポート」の部分に 8124 と入力する(このとき日本語入力はOFFにしておこう!)
  5.  同様にその下にある「SSLプロキシ」の部分に localhost (または127.0.0.1) と入力する.
      また右隣にある「ポート」の部分に 8124 と入力する(このとき日本語入力はOFFにしておこう!)
  6. virtual_usersを起動する.  
~~~
  以上である(先にvirtual_usersを起動させておいてもよい).

  ![screenshot](../imgs/screenshot_proxy_dialog.png)


  **【重要】**  
  元の設定に戻す(プロキシを使用しない)方法も覚えておこう.
  上記 3. において「プロキシを使用しない」という項目が一番上にある.
  これにチェックをつけることで、Firefoxはプロキシを介さない通常の状態に戻る.
  (Firefoxの初期設定では元々この状態のはずである)

  もしvirtual_usersの方が何か変なことになった場合は、一度virtual_usersを終了して再び起動させれば
  大抵の場合は問題は解消される. 万一閲覧しているサイトがどうしてもvirtual_usersを介した場合に
  うまく表示されないなど不具合が発生する場合は、ブラウザのプロキシ設定を元に戻した上で閲覧しよう.


## <a name="pos7">いっしょに含まれているmoaiとかhttp_decoratorとかZnkとかいうのは何なのか？
-----------------------------------

  Moai/Virtual USERSは我々のボスであるMr.Moai氏が開発したMoaiというローカルプロキシのラッパーであり、
  それを内部で呼び出す.
  また、DecoDecoBoy氏が**酔った勢いで**即興で書いた簡易HTTPクライアントhttp_decoratorも同様に呼び出す.
  libZnkは私ことZenkakuが開発したこれらをC言語で記述するための基本ライブラリである.
  そのため、これらがこのフォルダに含まれる.

  Moai/Virtual USERSはブラウザのクッキーやキャッシュなどを実際に消去したり、あなたのモニタの解像度を
  実際に変更したりなどといったことは勿論行わない. そうではなく通信の仲介役であるMoaiの
  フィルタを変更することによって、サイトへと送られる情報を改変し、そのような状況を仮想的に
  シミュレートしている.

  はるか上でMoai/Virtual USERSはブラウザと接続先サイトの通信の間に入ると書いたが、この仕事はほとんど
  Moaiが行っている. またfiltersやpluginsには、Moaiのフィルタや機能拡張のためのモジュールが
  格納されている.

  Moai自体はどこのサイト専用というわけではなく、あらゆるサイトに使うことができる汎用のツール
  である.  Moai/Virtual USERSでは、Moaiのフィルタやプラグイン機能を使って( 現時点ではfutaba向けの )
  モジュールを追加しており、Moaiは単にそれを読み込んで動作している形となる. 必要なら
  新たなサイト向けのフィルタやプラグインをあなたが新しく作ってMoaiの機能を拡張することも
  できる.


## <a name="pos8">さらなる詳細
-----------------------------------

  Moai/Virtual USERSに関するさらなる詳細は [リファレンスマニュアル(README_more.md)][1] をご覧いただきたい.
  内部エンジンであるMoaiに関しての詳細を知りたい方は、src/moaiにある[README][2]を参照して戴きたい.
  ただしこれの説明はここにあるものより技術的な解説であり、少し難しいかもしれない.


## <a name="pos9">ライセンス
-----------------------------------

  **NYSL**(煮るなり焼くなり好きにしろ)である.  
  ( NYSLについては http://www.kmonos.net/nysl を参照. )  
  現時点での公式のソースリポジトリは https://github.com/mr-moai-2016/znk_project であるが
  再配布はご自由にどうぞ.


## <a name="pos10">ご注意
-----------------------------------

  以下はmoaiにある[README][2]の抜粋である.

  Moaiは生まれたばかりのローカルプロキシでs(ry.
  現在はβバージョンという位置づけで、それゆえVersionを今現在0.9としてある.
  特に重要な内容を伴う情報の通信を確実に行う必要がある場合においては、
  念のためMoaiの使用を控えた方がよい. 

  また、このプログラムはポート番号8124においてクライアントからの接続をリッスンする.
  (このデフォルトのポート番号はconfig.myfより変更することもできるが、その場合は
   8124をその番号で読み替えて欲しい). 
  ここで言う「クライアント」とは、あなたのマシン、あるいは家庭内LANなど極めて小規模で
  安全性が明らかなマシン上に置かれたあなたの使うWebブラウザやその他のローカルプロキシ
  などを想定している. Moaiはローカルプロキシの名が示す通り、外部ネットワーク(WAN)から
  の不特定多数からの接続に関しては全く考慮されていない. 

  よってあなたがルータの設定を特別弄くっていない限りは通常は心配いらないことであるが、
  もしもconfig.myf内のacceptable_hostの値をANYに設定しており、かつお使いのルータで
  いくつかのポートへの外部からの接続要求をあなたが意図的に許可してあり、かつその許可
  ポートの中に8124が含まれている場合、それを必ず閉じ、外部ネットワークからのMoaiへの
  接続は確実に不許として置くこと.


## <a name="pos11">免責事項
-----------------------------------

  本ソフトウェアは「現状のまま」で、明示であるか暗黙であるかを問わず、
  何らの保証もなく提供されます. 本ソフトウェアの使用によって生じるいかなる損害についても、
  作者は一切の責任を負わないものとします.

  This software is provided 'as-is', without any express or implied warranty.
  In no event will the authors be held liable for any damages arising
  from the use of this software.


[1]: https://github.com/mr-moai-2016/znk_project/blob/master/src/virtual_users/README_more.md
[2]: https://github.com/mr-moai-2016/znk_project/blob/master/src/moai/README.md
[3]: https://github.com/mr-moai-2016/znk_project/blob/master/src/HowToCompile.md

# Virtual USERS リファレンスマニュアル
-----------------------------------

## 目次
-----------------------------------
* [フィルタターゲットとは？](#target)
* [受信フィルタについて](#filter_recv)
* [送信フィルタについて](#filter_send)
* [外部プロキシを使いたい場合どうするのか？](#proxy1)
* [その他のローカルプロキシにチェーンする場合](#proxy2)
* [手動で偽装を行った場合(参考)](#note1)


## <a name="target">ターゲットとは？
-----------------------------------
ターゲットとは、一つの短いキーワード(ターゲット名)により、いくつかのホストの集合を示すためのものである.
一つのターゲットにはいくつかのホスト名を列挙して、そのターゲット名によりグループ分けする形になる.
以下の例を見てみよう.

**【例】**  
例えば掲示板「２ちゃんねる」を対象として、ある種のフィルタを適用したいとしよう.
さらに別の掲示板「ふたばちゃんねる」を対象として、また別のフィルタ機能を適用したいとする.
target.myf 内で以下のように2chとfutabaいうtarget名を定義し(このtarget名はユーザが自由に決めることができる)、
それぞれに「２ちゃんねる」と「ふたばちゃんねる」のホスト名を列挙しておく.

~~~
@@L 2ch
hanabi.2ch.net
echo.2ch.net
penguin.2ch.net
@@.

@@L futaba
may.2chan.net
jun.2chan.net
dec.2chan.net
img.2chan.net
cgi.2chan.net
nov.2chan.net
dat.2chan.net
zip.2chan.net
@@.
~~~

これにより、その他の箇所では単に "2ch" と "futaba" というキーワードで、上記のホストの集合を示すことができる.
ちなみに、myfというファイルはこのプロジェクト全般において設定ファイルなどを記述するのに用いる汎用のフォーマットである.
これの仕様について知りたい方は[こちら][1]を参照していただきたい.


## <a name="filter_recv">受信フィルタについて
-----------------------------------
Virtual USERSでは、HTTPにおけるGETにて受信されるHTMLやJavascriptやCSSにおいて
その受信文字列を自由に置換(replace)できるフィルター機能を備えている.  
これを指定しているのが、filters/**TARGET_NAME**_recv.myf になる.
**TARGET_NAME**の部分にはtarget.myfにおいて定義したターゲット名が入る.

このファイル内の html_filter、js_filter、css_filterという部分で
それぞれHTML、Javascript、CSSにおける文字列の置換を行うことができる.
この部分にはfiltersコマンドと呼ばれる命令列を記述する.
現在サポートされているコマンドはreplaceのみで、以下の形式で記述する.

~~~
    replace ['置換前の文字列'] ['置換後の文字列']
~~~

これは「前者を後者で置換(replace)せよ」という命令になる.
これをhtml_filter内で書いておけば、**TARGET_NAME**で指定されたホストにおいて
拡張子がHTMLのファイルのすべての行に対し、この文字列置換が行われる.
js_filter、css_filterについても同様である.

置換前の文字列と置換後の文字列は
必ず [' と '] というクォーティング記号で囲う必要があることに注意すること.
大抵の用途では、このクォーティング記号で問題は起こらないと思われるが、
置換対象文字列内にこの記号が含まれるなどで、この記号だと都合が悪い場合は、
ファイルの最初の行にある @def_quote ディレクティブでこの記号を自由に変更することもできる.
例えば [' と '] の替わりに ([ と ]) を使いたいといった場合は、myfファイルの一番最初の行に
~~~
    @def_quote ([ ])
~~~
と書いておく.


**【例】**  
例えば掲示板「２ちゃんねる」を対象として、その受信HTMLとCSSを加工したいとしよう.
target.myf内で例えば2chという名前のtargetを定義し、filters/2ch_recv.myfというファイルを作成する.
このファイル内で以下のフィルタコマンドを指定する.

~~~
@@L html_filter
replace ['<b>デフォルトの名無しさん</b>'] ['<b>デフォルトのモアイさん</b>']
replace ['">デフォルトの名無しさん</a>'] ['">デフォルトのモアイさん</a>']
@@.

@@L css_filter
replace ['{background:rgb(239,239,239)}'] ['{background:rgb(240,224,214); color:rgb(127,0,0)}']
@@.
~~~

ファイルが作成できたら、Virtual USERSを起動(再起動)し、この状態で普通に「２ちゃんねる」へとアクセスする.
以下はその表示結果である.  

![screenshot](../imgs/screenshot_recv.png)

HTMLの内容が加工されて、名前欄の文字列が変更されていることがわかる.
またCSSの内容が加工されて、背景色と文字色も変更されている.  
もしも正しく設定したにもかかわらず表示が変わらないなら、ブラウザのキャッシュに古い情報が残っている
可能性がある. キャッシュをクリアしてからもう一度目的のサイトへアクセスしよう.


## <a name="filter_send">送信フィルタについて
-----------------------------------
Virtual USERSでは、HTTPにおけるPOSTにて送信されるヘッダやPOST変数、クッキーの値において
その値の内容をある程度自由に置換(replace)できるフィルター機能を備えている.  
これを指定しているのが、filters/**TARGET_NAME**_send.myf になる.
**TARGET_NAME**の部分にはtarget.myfにおいて定義したターゲット名が入る.

このファイル内の header_vars、post_vars、cookie_varsという部分で
それぞれHTTPヘッダ、POST変数、Cookieにおける値の置換を行うことができる.
この部分には以下の変数代入形式を記述する.

~~~
    varname = ['置換後の値']
~~~

このファイル内において varname が指定されていない変数に関しては勿論何も加工修正はされない.
また右辺の置換後の値が空値のときは、空値へと置換される.
また中間処理のため、実際に送信されるPOST変数に存在しない変数などを記述しておくこともできる.
その場合はフィルタ処理においてはその変数は単に無視される.

**【例】**  
例えば掲示板「ふたばちゃんねる」を対象として、その送信ヘッダとPOST変数とCookieの値を加工したいとしよう.
target.myf内で例えばfutabaという名前のtargetを定義し、filters/futaba_send.myfというファイルを作成する.
このファイル内で以下の指定を行う.

~~~
@@V header_vars
User-Agent = ['Mozilla/5.0 MyBrowser_MoreMoreFireSexy']
@@.

@@V post_vars
name = ['モア!!モア!!モアーイ']
email = ['moge']
@@.

@@V cookie_vars
cxyl = ['8x16x2x0x2']
namec = ['']
@@.

~~~

ファイルが作成できたら、Virtual USERSを起動(再起動)し、この状態で普通に「ふたばちゃんねる」へとアクセスする.
この例では、HTTPヘッダ変数のうち、User-Agent の値を「Mozilla/5.0 MyBrowser_MoreMoreFireSexy」へと変更している.

また、POST変数のうち、上記で指定したものの値を変更している.
これにより、レス投稿時にお名前欄とE-mail欄が強制的に「モア!!モア!!モアーイ」および「moge」となる.

> このようにVirtual USERS(およびMoai)では、POST変数のフィルタリングを比較的簡易に実現できる.
> これに関しては同種のツールであるProxomitronなどに比べて有利な点の一つである.

最後にCookie変数のうち、上記で指定したものの値を変更している.
ここでcxylというのは、
~~~
    横のスレ個数 x 縦のスレ個数 x 各スレでの文字数 x 文字位置(0:下,1:右) x 画像サイズ(0から6までで0が最小で旧来の表示)
~~~
というフォーマットを持つ記述子であり、これを指定しない場合はデフォルトとして ['14x6x4x0x0'] を指定したものとみなされる.

またnamecというのは、最後のレスにおいて使用したお名前欄の内容であり、
ここではこれを強制的に空値へとリセットしている.


[1]: https://github.com/mr-moai-2016/znk_project/blob/master/src/libZnk/myf_spec.md
## <a name="proxy1">外部プロキシを使いたい場合どうするのか？
-----------------------------------

  ブラウザのプロキシ設定ダイアログには既にlocalhost(127.0.0.1)を指定してしまっている.
  これでは外部プロキシを利用できなくなるので困るという方もおられよう.

  Virtual USERSでは次の接続仲介先として外部プロキシを設定することも一応できる.
  そのためにはコマンドラインから以下のように引数を与えて実行する

     virtual_users  外部プロキシのIP  外部プロキシのポート

  このときは、概念的に次のような接続になる.

  あなたのブラウザ環境 => ローカルプロキシVirtual USERS => 外部プロキシ => 送信先のサイト

  しかしIPアドレスを変えるだけなら通常はルーカチで十分であるし、そもそも有効な外部プロキシ
  を見つけること自体がかなり難しい. 尚、外部プロキシのサポートはまだ試験的なものであり、
  特にプロキシによっては通信が不安定になる場合もある. というわけでこの機能を使うのは
  初心者にはお勧めしない.


## <a name="proxy2">その他のローカルプロキシにチェーンする場合
-----------------------------------

  Virtual USERSはその他のローカルプロキシと併用することもできる.
  例えばPolipoとのコラボも可能であることを確認している.
  これによってPolipoとVirtual USERSの恩恵を同時に享受できる.
  概念的に次のような接続になる.

  あなたのブラウザ環境 => ローカルプロキシVirtual USERS => ローカルプロキシPolipo => 送信先のサイト

  あるいは以下のように順番が逆でも可能である.

  あなたのブラウザ環境 => ローカルプロキシPolipo => ローカルプロキシVirtual USERS => 送信先のサイト

  設定手順は外部プロキシを指定する場合と全く同様に行える.
  おそらくデフォルトではPolipoとVirtual USERSは同じポートを使っているので、これらが異なるように
  変更しなければならない. 例えばPolipoのポートはデフォルトの8123のままとして、
  Virtual USERSの使用ポートを8122に変えるなどする(config.myf 内のmoai_portの値を変えればよい).


## <a name="note1">手動で偽装を行った場合(参考)
-----------------------------------

  参考のため、Virtual USERSのようなツールを使わず、手動で偽装する方法も記載しておいた.
  以下のはふたばの例であるが、このような偽装を全て漏れなく手動でやろうとした場合、
  以下のようにかなりの手間となる.

~~~
  1. ブラウザで開いているふたば関係のタブを一旦閉じる.
     これによりうっかりPOST変数などが残留してしまう可能性を排除する.
     キャッシュを消してもこれが消えずに残る場合もあるため一旦閉じた方が確実だろう.

  2. ルーカチする.

  3. ブラウザのクッキー、キャッシュ、localStorageを消去.
     localStorageの消去についてはブラウザ毎に異なるが、Firefoxの場合
     「オフラインWebページとユーザデータ」とある部分で「今すぐ消去」ボタンを押す.

  4. User-Agentの値を変更する. 
     最も安直な方法は、使うブラウザを変更することである.
     あるいは使ってるブラウザにUser-Agent偽装アドオンなどが存在するならそれを入れて
     別の値に設定する.

  5. 新しいタブを開いた上で1で閉じたふたば関係のページなどに再度アクセスする.
     逆に言えばこの段階になるまでは、まだふたば関係のページを開いてはいけない.

  6. モニタの解像度や色深度を変更する.
     最も安直な方法は、モニタのプロパティより解像度と色ｓ…
     …というか、たかがふたばのためにこんなことまで実際にはやってられないので、
     ここは以下にある「POST変数を手動で修正する方法」によって、POST変数scszを直接変更する.

  7. POST変数 flrv, flvv(Fingerprint)の値を変更する. 
     flrvはUser-Agentを変更すればその値も変わる.
     一方、最近導入されたflvvはUser-Agentを変更しても変わらない.
     よって以下にある「POST変数を手動で修正する方法」によって、POST変数flvvを直接変更する.
     値は32bit整数なら何でもよい.
     (ついでにflrvも直接変更しておけばよかろう. ただしflvvとは異なる32bit整数値にしておく)

  8. jsの値をonに変更する. 
     最も安直な方法は、女子小学生へonして変態すｒ…
     ではなく、この値はJavaScriptを実行したかどうかを判断するためのものであり、
     /bin/base4.js を実行すると on に設定される仕組みとなっている.
     これを on にしておかないと「環境変数がありません(JavaScriptがオフ？)」という
     エラーが表示され、投稿に失敗する.
     よって以下にある「POST変数を手動で修正する方法」によって、POST変数jsの値をonに変更する.

  9. レス投稿またはスレ立て.
     「Cookieを有効にしてください」と出る場合は、もう一度投稿.
      本当にCookieを無効にしていない限りは、2回目はうまくいくはずである.
~~~

#####  ※ POST変数を手動で修正する方法
~~~html
  Step1.
    まずスレのHTMLを保存する

  Step2.
    次に保存したスレのHTMLをテキストエディタ(メモ帳など)で開き、
    その中身を直接書き換えて修正する
    <script type="text/javascript" src="/bin/base4.js?4"></script> などと書かれた部分があるはずである
    ぶっちゃげこのbase4.jsが邪悪の元凶であり、コイツが忌々しい数々の変数の値を設定している.
    そしてこのままでは base4.js を実行してしまうので、これが実行されないよう、この部分を削除する.

  Step3.
    後は <input type=hidden…> などと書かれている部分を好き放題変えればよいのだが、
    例えばflrvならば、

       <input type=hidden id="flrv" name="flrv" value="">

    などと書かれてあるが、この部分を

       <input type=hidden id="flrv" name="flrv" value="77777777"> 

    とすれば晴れてflrvの値を77777777に偽装できる.

  後は修正したHTMLをダブルクリックして、表示される投稿フォームから投稿すれば
  上において偽装された値が送信されることだろう.
~~~


# Moai リファレンスマニュアル
-----------------------------------

## <a name="index">目次
-----------------------------------
* [ターゲットとは？](#target)
* [受信フィルタについて](#filter_recv)
* [送信フィルタについて](#filter_send)
* [無用なホストへの接続をブロックする(ignore_hosts機能)](#ignore_hosts) 
* [POST時の確認メッセージ表示(post_confirm機能)](#post_confirm)
* [LAN内における他のマシンからの接続を許可/制限する](#acceptable_host)
* [外部プロキシを使いたい場合どうするのか？](#proxy1)
* [外部プロキシをゴールとなるホストに応じて選択的に適用する方法](#proxy2)
* [その他のローカルプロキシにチェーンする場合](#proxy3)
* [Moai Web Configuration](#web_config)
* [プラグイン機能について](#plugin)


## <a name="target">ターゲットとは？
-----------------------------------
ターゲットとは、一つの短いキーワード(ターゲット名)により、いくつかのホストの集合を示すためのものである.
一つのターゲットにはいくつかのホスト名を列挙して、そのターゲット名によりグループ分けする形になる.
以下の例を見てみよう.

**【例】**  
例えば掲示板「２ちゃんねる」を対象として、ある種のフィルタを適用したいとしよう.
さらに別の掲示板「ふたばちゃんねる」を対象として、また別のフィルタ機能を適用したいとする.
target.myf 内で以下のように2chとfutabaいうtarget名を定義し(このtarget名はユーザが自由に決めることができる)、
それぞれに「２ちゃんねる」と「ふたばちゃんねる」のホスト名を列挙しておく.

~~~
@@L 2ch
*.2ch.net
@@.

@@L futaba
*.2chan.net
@@.
~~~

これにより、その他の箇所では単に "2ch" と "futaba" というキーワードで、上記のホストの集合を示すことができる.
ちなみにここでのパターンの記述においては一行につき一箇所のみにワイルドカードを使うこともできる.
少し脱線するが、例えば以下の記述はOKであり、アスタリスクの部分は任意の文字列と考えてよい.
例えば may.2chan.net、jun.2chan.net などがこれにマッチする.

~~~
*.2chan.net
~~~

一方、例えば以下の記述は意図した通りのものとはならない.
~~~
*.2chan.*
~~~
この場合、一番目に現れたアスタリスクのみがワイルドカードとして扱われ、
二番目に現れたアスタリスクは、文字通りアスタリスクそのものとして扱われる.

myfというファイルはこのプロジェクト全般において設定ファイルなどを記述するのに用いる汎用のフォーマットである.
これの仕様について知りたい方は[こちら][1]を参照していただきたい.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="filter_recv">受信フィルタについて
-----------------------------------
Moaiでは、HTTPにおけるGETにて受信されるHTMLやJavascriptやCSSにおいて
その受信文字列を自由に置換(replace)できるフィルター機能を備えている.  
これを指定しているのが、filters/**TARGET_NAME**_recv.myf になる.
**TARGET_NAME**の部分にはtarget.myfにおいて定義したターゲット名が入る.

このファイル内の html_filter、js_filter、css_filterという部分で
それぞれHTML、Javascript、CSSにおける文字列の置換を行うことができる.
この部分にはfiltersコマンドと呼ばれる命令列を記述する.
現在サポートされているコマンドはreplaceのみで、以下の形式で記述する.

~~~
    replace ['置換前の文字列'] ['置換後の文字列']
~~~

これは「前者を後者で置換(replace)せよ」という命令になる.
これをhtml_filter内で書いておけば、**TARGET_NAME**で指定されたホストにおいて
拡張子がHTMLのファイルのすべての行に対し、この文字列置換が行われる.
js_filter、css_filterについても同様である.

置換前の文字列と置換後の文字列は
必ず [' と '] というクォーティング記号で囲う必要があることに注意すること.
大抵の用途では、このクォーティング記号で問題は起こらないと思われるが、
置換対象文字列内にこの記号が含まれるなどで、この記号だと都合が悪い場合は、
ファイルの最初の行にある @def_quote ディレクティブでこの記号を自由に変更することもできる.
例えば [' と '] の替わりに -[ と ]- を使いたいといった場合は、myfファイルの一番最初の行に
~~~
    @def_quote -[ ]-
~~~
と書いておく( -[ と ]- の間には必ずスペースを入れること ).


**【例】**  
例えば掲示板「２ちゃんねる」を対象として、その受信HTMLとCSSを加工したいとしよう.
target.myf内で例えば2chという名前のtargetを定義し、filters/2ch_recv.myfというファイルを作成する.
このファイル内で以下のフィルタコマンドを指定する.

~~~
@@L html_filter
replace ['<b>デフォルトの名無しさん</b>'] ['<b>デフォルトのモアイさん</b>']
replace ['">デフォルトの名無しさん</a>'] ['">デフォルトのモアイさん</a>']
@@.

@@L css_filter
replace ['{background:rgb(239,239,239)}'] ['{background:rgb(240,224,214); color:rgb(127,0,0)}']
@@.
~~~

ファイルが作成できたら、Moaiを起動(再起動)し、この状態で普通に「２ちゃんねる」へとアクセスする.
以下はその表示結果である.  

![screenshot](../imgs/screenshot_recv.png)

HTMLの内容が加工されて、名前欄の文字列が変更されていることがわかる.
またCSSの内容が加工されて、背景色と文字色も変更されている.  
もしも正しく設定したにもかかわらず表示が変わらないなら、ブラウザのキャッシュに古い情報が残っている
可能性がある. キャッシュをクリアしてからもう一度目的のサイトへアクセスしよう.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="filter_send">送信フィルタについて
-----------------------------------
Moaiでは、HTTPにおけるPOSTにて送信されるヘッダやPOST変数、クッキーの値において
その値の内容をある程度自由に置換(replace)できるフィルター機能を備えている.  
これを指定しているのが、filters/**TARGET_NAME**_send.myf になる.
**TARGET_NAME**の部分にはtarget.myfにおいて定義したターゲット名が入る.

このファイル内の header_vars、post_vars、cookie_varsという部分で
それぞれHTTPヘッダ、POST変数、Cookieにおける値の置換を行うことができる.
この部分には以下の変数代入形式を記述する.

~~~
    varname = ['置換後の値']
~~~

このファイル内において指定されていない変数に関しては何も加工修正はされず、単にそのまま送られる.
また右辺の置換後の値が空値のときは、文字通り空値へと置換される.
また中間処理のため、実際に送信されるPOST変数に存在しない変数などを記述しておくこともできる.
この場合、フィルタ処理においてその変数は単に無視される.

**【例】**  
例えば掲示板「ふたばちゃんねる」を対象として、その送信ヘッダとPOST変数とCookieの値を加工したいとしよう.
target.myf内で例えばfutabaという名前のtargetを定義し、filters/futaba_send.myfというファイルを作成する.
このファイル内で以下の指定を行う.

~~~
@@V header_vars
User-Agent = ['Mozilla/5.0 MyBrowser_MoreMoreFireSexy']
@@.

@@V post_vars
name = ['モア!!モア!!モアーイ']
email = ['moge']
@@.

@@V cookie_vars
cxyl = ['5x3x2x0x2']
namec = ['']
@@.

~~~

ファイルが作成できたら、Moaiを起動(再起動)し、この状態で普通に「ふたばちゃんねる」へとアクセスする.
この例では、HTTPヘッダ変数のうち、User-Agent の値を「Mozilla/5.0 MyBrowser_MoreMoreFireSexy」へと変更している.

また、POST変数のうち、上記で指定したものの値を変更している.
これにより、レス投稿時にお名前欄とE-mail欄が強制的に「モア!!モア!!モアーイ」および「moge」となる.

> このようにMoaiでは、POST変数のフィルタリングを比較的簡易に実現できる.
> これに関しては同種のツールであるProxomitronなどに比べて有利な点の一つである.

最後にCookie変数のうち、上記で指定したものの値を変更している.
ここでcxylというのは、
~~~
    横のスレ個数 x 縦のスレ個数 x 各スレでの文字数 x 文字位置(0:下,1:右) x 画像サイズ(0から6までで0が最小で旧来の表示)
~~~
というフォーマットを持つ記述子であり、これを指定しない場合はデフォルトとして ['14x6x4x0x0'] を指定したものとみなされる.

またnamecというのは、最後のレスにおいて使用したお名前欄の内容であり、
ここではこれを強制的に空値へとリセットしている.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="ignore_hosts">無用なホストへの接続をブロックする(ignore_hosts機能) 
-----------------------------------
Moaiでは、config.myf 内の ignore_hosts において記載されているホストへブラウザが接続しようとした場合
それをブロックすることができる.
例えばあなたがいつも見ているサイト内に大量の広告があり、それらのバナーなどが外部サイトにある場合
このままではそれらの外部サイトすべてに対して「TCPコネクションの確立」を行わなければならない.
「TCPコネクションの確立」という処理は非常に重い(時間がかかる)ので、本当に表示の高速化を図りたいなら
無駄な接続を未然に防ぐのが一番効果的なのである.

以下に例を示す.
ちなみにここでのパターンの記述においては一行につき一箇所のみにワイルドカードを使うこともできる.

~~~
@@L ignore_hosts
free2.jp
api.digiket.com
js.ad-stir.com
aladdin.genieesspv.jp
*.socdm.com
j.microad.net
www.assoc-amazon.jp
@@.
~~~

configファイル中に例えばこのように記述しておくと、あなたがいつも見ているサイトのページ中に
上記の外部サイトへアクセスしようとする部分がある場合、それらの外部サイトへの接続を未然に防止する.
そして替わりにその部分には以下のようなメッセージが表示される.

  Moai : Ignored Host Blocking[**blocked_hostname**] sock=[1234].

**blocked_hostname**の部分には、どのホストへのアクセスをブロックしたかが表示される.  
つまり上記で指定したホストのいずれかが表示されるはずである.  
sockの部分は気にする必要はないが、接続の際に使ったソケットの番号を示している.


## <a name="post_confirm">POST時の確認メッセージ表示(post_confirm機能) 
-----------------------------------
ここで簡単におさらいしよう.
POSTとは掲示板などへスレ立てやレス投稿をする際に行われるHTTPリクエストのことである.
そしてこのときHTTPヘッダやサーバが定義した変数(POST変数と呼ぶ)、クッキーの値などが送信される.

config.myf内のpost_confirmの値が on のとき、これらの値をすべて表示する確認画面を出すことができる.
一方、この値が off のときは、すべてのサイトに対してこの確認画面は表示は無効となる.
(テキストだけの非常に地味な画面ではあるが、これからそのサイトに何が送られるかが余すことなく表示され、
 状況を把握や分析をするには十分役に立つだろう).

![screenshot](../imgs/screenshot_post_confirm.png)

ただし、この画面が表示されるのはconfig.myf内にあるpost_confirm_hostsに記載されたホストに対してPOSTする場合のみである.
(そこに記載されていないホストに対してはpost_confirmがonであってもこの画面は表示されない).
ちなみにここでのパターンの記述においてはtargetでの指定と同様の形でワイルドカードを使うこともできる.

ところで、post_confirm_hostsなどで範囲を絞らずにすべてのサイトで有効にすればよいのではないかと思われる方もいるだろうが
Nico動画など一部のサイトでは、スクリプトなどで自動的なPOSTが内部で行われている場合があり、
そのような場合これを有効にしておくと問題が発生するため、この画面が発動するホストを選択指定できるようにしてある.

【注意】
例えばふたば用のアドオン赤福などを使用している場合、このモードがonの場合に内部処理が競合し、
レス送信などがうまく行えないようである.
赤福が有効な状態で、この確認画面をうまく表示する方法は今のところみつかっていない.
赤福の方を無効にするわけにもいかないであろうから、その場合もやはりpost_confirmそのものを無効にしておく必要がある.
というわけで、この指定はデフォルトではoffとしてある.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="acceptable_host">LAN内における他のマシンからの接続を許可/制限する
-----------------------------------
Moaiは他のマシンからの接続もサポートする.

これはご家庭にある２台目３代目のマシン等から、Moaiの起動している１台目のマシンへ接続して
Moaiの提供する機能を利用するといったような用途を想定している.

この接続の許可/不許の関門としてMoaiは２段階設けてある.
あるIPからの接続を通過させるには、この双方を許可する必要がある.

まず第１の段階として、config.myf内のacceptable_hostにおける指定がある.
この値でANYを指定することにより他のマシンからの接続が可能となり、LOOPBACKを指定することにより、
自マシン以外は問答無用で遮断するようになる.
デフォルトでは安全のため、一応LOOPBACKとしてある.

次に第２の段階として、config.myf内のaccess_allow_ips と access_deny_ips の指定において
許可/不許の切り分けが行える.
access_allow_ips において接続を許可するIP群を指定する(ホスト名ではなく必ずIPでなければならない).
ここにに何も記述しない場合は、デフォルトでlocalhostを除くすべてのマシンからの接続を不許とする
(この場合、接続元にはForbiddenメッセージを返す形になる).

このaccess_allow_ipsの指定だけでも通常十分であるが、ここからさらに例外的に接続を不可とする
IP群をaccess_deny_ipsにおいて追加で指定できる.

例えばLAN内からのみの接続を許可するには、典型的には以下の記述でよいだろう.
ちなみにパターンの記述においては一行につき一箇所のみにワイルドカードを使うことができる.

~~~
@@L access_allow_ips
192.168.*
@@.
~~~

さらに例えばLAN内の192.168.1.66のマシンのみ、理由あって接続を不許としたい場合は、
access_allow_ipsに以下を記述しておくとよい.

~~~
@@L access_deny_ips
192.168.1.66
@@.
~~~

勿論、ルータやOSなどにあるファイアウォール機能でWAN(外部インターネット)からのポート8124への
接続ができないようきちんと防御するのもセキュリティ上有効な対策だ.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="proxy1">外部プロキシを使いたい場合どうするのか？
-----------------------------------

ブラウザのプロキシ設定ダイアログには既にlocalhost(127.0.0.1)を指定してしまっている.
これでは外部プロキシを利用できなくなるので困るという方もおられよう.

Moaiでは次の接続仲介先として外部プロキシを設定することができる.
このときは、概念的に次のような接続になる.

あなたのブラウザ環境 => ローカルプロキシMoai => 外部プロキシ => 送信先のサイト

これを実現するためには config.myf の parent_proxy の値を以下の形式で与える.

~~~
     外部プロキシのホスト名またはIP:外部プロキシのポート
~~~

例えば以下のように記述することで外部プロキシproxy.example.net:3128を経由して目的のサイトへ
アクセスすることができる(proxy.example.net:3128が有効であればの話だが).

~~~
     parent_proxy = ['proxy.example.net:3128']
~~~

外部プロキシを使わない場合(目的のサイトへ直接アクセスする場合)は値として以下のようにNONEを指定する.
(あるいは空値または :0 でもよい)

~~~
     parent_proxy = ['NONE']
~~~

尚、moaiと同フォルダ内にparent_proxy.txtというファイルを作り、そこに使用したいプロキシの候補を
複数列挙しておくことで、Moai Web Configuration上でこれらのプロキシがメニュー表示されるようになる.
このメニューより、現在使用するプロキシを簡単かつ瞬時に切り替えすることも可能だ.

ところでIPアドレスを変えるだけなら通常はルーカチで十分であるし、有効な外部プロキシを見つけるのもそう簡単ではない.
というわけでルーカチが使える状況ならばそちらの使用をお勧めする.


## <a name="proxy2">外部プロキシをゴールとなるホストに応じて選択的に適用する方法
-----------------------------------
例えば、あるサイトdanger.netを見る場合のみ外部プロキシを使用したいとする.
(その他すべてのサイトでは外部プロキシを使用したくないとする).
外部プロキシを介すると表示が遅くなったりするので、使う必要がないサイトならば使わない方が快適だ.

その場合、config.myf内のproxy_applyに外部プロキシを使用したいサイトを記述しておく.
また、同じくconfig.myf内のproxy_exceptに例外的に外部proxyを使わないサイトを記述しておく.
尚、proxy_applyと被るものについてはproxy_exceptの指定が優先される.

以下に例を示す.


~~~
@@L proxy_apply
*.2chan.net
taruo.net
@@.

@@L proxy_except
@@.
~~~

上記のように記述した場合、最終的にアクセスする目的のサイトが例えば may.2chan.netの場合は、
proxy_applyに一致するパターンが存在するので、外部プロキシを中継する.
上記の記述に存在しないその他の一般サイトを見る場合は(たとえparent_proxyに何が設定されていようとも)
外部プロキシは使われない.

また、この考え方を逆にした指定もできる.

例えば、あるサイトを見る場合のみ外部プロキシを使用しないとする.
(その他すべてのサイトでは外部プロキシを使用したいとする).
その場合は以下のようにすればよい.

~~~
@@L proxy_apply
*
@@.

@@L proxy_except
safe.net
127.0.0.1
localhost
192.168.*
@@.
~~~

上記のように記述した場合、最終的にアクセスする目的のサイトがsafe.netまたはlocalhostや127.0.0.1、
あるいはIPが同じ 192.168.* のLAN上のマシンの場合、(たとえparent_proxyに何が設定されて
いようとも)外部プロキシは使われない.
その他の一般サイトを見る場合は、parent_proxyの記述に応じた外部プロキシが使われる形になる.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="proxy3">その他のローカルプロキシにチェーンする場合
-----------------------------------

Moaiはその他のローカルプロキシと併用することもできる.
例えばPolipoとのコラボも可能であることを確認している.
これによってPolipoとMoaiの恩恵を同時に享受できる.
概念的に次のような接続になる.

あなたのブラウザ環境 => ローカルプロキシMoai => ローカルプロキシPolipo => 送信先のサイト

設定手順は外部プロキシを指定する場合と全く同様に行える.
おそらくデフォルトではPolipoは8123ポートを使っているので、parent_proxyに直接localhost:8123を指定するか
あるいは parent_proxy_list に localhost:8123 を追加しておき、必要になったら Moai Web configrationにおいて
parent_proxyからそれを選べばよい.

あるいは以下のように順番が逆でも可能である.

あなたのブラウザ環境 => ローカルプロキシPolipo => ローカルプロキシMoai => 送信先のサイト

この場合はPolipo側の設定ファイルを変更し、Moai(ポート8124)へ接続するようにしなければならない.
すなわちPolipoのconfig.cfgにおいて parentProxyをlocalhost:8124とする形になるだろう.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="web_config">Moai Web Configuration
-----------------------------------
  ブラウザのURL指定欄に http://127.0.0.1:8124/config と指定することで表示させることができる.
  これまでに述べたconfig.myf内の変数をWeb上から確認および設定できるというものである.

  ![screenshot](../imgs/screenshot_config.png)

  **Filters and Plugins**  
  ここではプラグインとして登録されているターゲットのVirtual USERS Initiation機能を呼び出す.
  これにより、具体的に何が実行されるかはプラグインによるが、その実行結果がすぐ下に表示される.
  例えば、掲示板の投稿用sendフィルタの変数値をランダマイズ化したり仮想化したりなどが
  「Virtual USERS Initiation」ボタンにより行える.

  **Functional Configuration**  
  ここではMoaiの機能に関する設定を行う.
  parent_proxy:
  このメニューでは parent_proxy.txt の内容が表示される.
  ここから現在使用するプロキシを選んで「Update」を押せば使用する外部プロキシの瞬時切り替えができる.  

  **System Configuration**  
  ここではMoaiの通信システムの根本に関わる設定を行えるが、設定を変更される場合は細心の注意が必要である. 
  またこの設定変更はMoaiが起動しているマシン上からしか行えないようになっている.
  (外部マシンからリモートでは行えないということ).
  「Update System」ボタンを押すことでMoaiを再起動するよう促すメッセージが表示される.
  そこからさらに「Restart Moai」ボタンを押すことでMoaiサーバが再起動され設定が反映される形となる.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="plugin">プラグイン機能について
-----------------------------------
この項目はプログラマ以外の方は読む必要はない.

MoaiのVirtual USERSプラグインでは以下のダイナミックロード可能なグローバル関数を C 言語により実装する.
Ver1.0においてサポートされる関数は以下である.

~~~c
  bool initiate( ZnkMyf ftr_send, const char* parent_proxy,
      char* result_msg_buf, size_t result_msg_buf_size );

    target固有のsendフィルタの初期化処理を行う.
    Web Configurationの「Virtual USERS Initiation」ボタンを押すとこの関数が呼び出される.

    ftr_send:
    初期化対象となるフィルタへの参照である.
    これがどう加工されるのかはあなたがこの関数をどう実装するかによる.

    parent_proxy:
    Moaiが現在使用中の外部プロキシがhostname:portの形式で設定されている.
    (外部プロキシを使用していない場合はこの値が空値であるかまたはNONEであるかまたは:0が指定されている)

    result_msg_buf:
    ここにはこの関数の処理をおこなった結果のメッセージを格納しなければならない.
    これは処理が成功した場合はそれをリポートメッセージであり、エラーが発生した場合はそれを示す
    エラーメッセージとなる.
    「Virtual USERS Initiation」ボタンを押すとすぐ下にこのメッセージが表示される形になる.

    result_msg_buf_size:
    result_msg_bufのメモリ上に確保されたバッファの大きさを正しく指定すること.

  bool on_post_before( ZnkMyf ftr_send );

    target固有のPOST直前時の処理を行う.
    POST直前に毎回呼び出される.

    ftr_send:
    処理対象となるフィルタへの参照である.
    これがどう加工されるのかはあなたがこの関数をどう実装するかによる.

  bool on_response_hdr( ZnkMyf ftr_send, ZnkVarpAry hdr_vars );

    target固有のレスポンスヘッダを受け取った場合における処理を行う.
    レスポンスを受け取った場合に毎回呼び出される.

    ftr_send:
    処理対象となるフィルタへの参照である.
    これがどう加工されるのかはあなたがこの関数をどう実装するかによる.

    hdr_vars:
    処理対象となるレスポンスヘッダへの参照である.
    これがどう加工されるのかはあなたがこの関数をどう実装するかによる.
~~~

  <a href="#user-content-index">目次へ戻る</a>


[1]: https://github.com/mr-moai-2016/znk_project/blob/master/src/libZnk/myf_spec.md

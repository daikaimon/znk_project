# ソース改造および機能拡張のためのガイドライン
-----------------------------------

## <a name="index">目次
-----------------------------------
* [Hacking? ハッカーって奴っすかｗ？](#hacking)
* [Cooking? クッキーって奴っすかｗ？](#cooking)
* [開発言語および開発にあたっての背景など](#lang_and_background)
* [プラグインインターフェース](#plugin)


## <a name="hacking">Hacking? ハッカーって奴っすかｗ？
-----------------------------------
そうっすよｗあのハッカーっすよｗ  
以下に正しい定義を書いておくっすよｗ

>「ハッカー」っていうのはみんなも知っている通り、コンピュータで悪いことする犯罪者で
>「ハッキング」ってのはハッカーがコンピュータで**けしからんこと**することである.

さて、こんなことを書くと我々の経験上、**鼻息を荒げながら**次のような反論をするおっさん(いやもはやジジイかｗ)が
いずこからともなく現れるのであったｗ

>けしからんのはお前さんの方だバカモノ！
>
>「ハッキング」っていうのは本来コンピュータを解析することであって、
>「ハッカー」はコンピュータを解析する者のことだ!
>コンピュータで悪いことする犯罪者は正しくは「クラッカー」と言い、
>コンピュータでけしからんことするのは「クラッキング」と言うのだ！
>
>二度と間違えるなｺﾞﾙｧ！(` Д´)／ﾊｱﾊｱ

まあ我々としては、もはや**こんな化石のような定義**など、今更どうでもいいわけだがｗ  
「ハッカー」っていう言葉は、コンピュータで悪いことする犯罪者として今や社会に浸透しているのだから.

…とここまで書いておいてアレだが、他に適当な言葉も思いつかなかったので
このファイル名も多くのオープンソースプロジェクトがそうしているようにHackingという名前にしちゃいましたですハイ!

ここでのHackingの意味は、**化石脳達**が言う意味に近いだが、要するにこのツールを改造したり
拡張したりするといった程度の意味である(最近ではクラッキングという言葉がこの意味でも使われたりするようである).

というわけで、例によって前置きが長くなったが、このドキュメントはプログラマの方専用となっております.
プログラマでない方は、以下とっても危険なのでお逃げくださいｗ

  <a href="#user-content-index">目次へ戻る</a>


## <a name="cooking">Cooking? クッキーって奴っすか？
-----------------------------------
※本製品は観賞用であり、食べられません.

  ![screenshot](./imgs/do_not_eat.png)

  <a href="#user-content-index">目次へ戻る</a>


## <a name="lang_and_background">開発言語および開発にあたっての背景など
-----------------------------------

  さて、本題に入ろう.

  ここでは開発言語としてCを使ってある.
  そして今回リリースしたバージョンでは実行効率より確実性を最優先にしてある.

  C++ならばもっと記述は簡潔になる部分もあろうが、それは同時にデバッグの際における
  非シーケンシャルかつ非直感的な処理の割合が高くなることも意味する.
  特にコンストラクタやデストラクタの発動のタイミングやコンパイラ依存の差異や癖などですら、
  デバッガでも追跡困難なバグを誘発する.
  というわけで我々はどうでもいい開発にはC++を使うこともあるがそうではない場合はC++は
  基本的に使わない.
  ちなみに基本ライブラリであるlibZnkはC/C++いずれからでも使用可能である.

  その他メジャーなスクリプト言語(rubyやpythonなど)は大抵の場合良い選択だが、
  インタプリタや付属ライブラリのバージョンアップなどで、今まで問題なく動作していたものが
  突然エラーになるなどよくある話ではある. また万一その言語に未知のバグがあったり
  ドキュメントされていないある種の癖に由来した不具合が発生した場合、スクリプト環境
  に付属した膨大なコードから原因を探すなどやってられないので今回は不採用とした.

  このツールは本体そのものの改造や、プラグインによる拡張もしやすいと思う. 技術のある方は是非挑戦してもらいたい. 
  (特にMacOSへの対応は大いに歓迎する). 勿論あなたが書くのだからお好きな言語で書きなおしてもらってもいい.
  そして改造したものを是非とも公開して戴ければ我々にとってこれ以上の喜びはない
  (ソースコード公開の義務など微塵もないが、上に書いてある通り公開した方が
   より多くの人に使ってもらえる確率は高くなると思う). 

  ところでPolipoもCで記述されたオープンソースであり、実のところ当初はこれを改造して
  Lolipo(失礼ｗ)というツールでリリースする予定でいたのだが、Polipoのコードは関数名や
  グローバル変数名の命名規則や、それらの依存関係があまりに汚かった(失礼ｗ)ので、
  今回Moaiという新しいツールをフルスクラッチで開発する方が早いという結論に至った. 
  とはいえPolipoは非常に優れたツールであり、多くの部分を参考にさせてもらった.
  この場を借りてJuliusz Chroboczek氏には感謝する. ポート番号8123はPolipoで使われていたものであり、
  それに敬意を表しMoaiではこれのお隣という意味で8124をデフォルトポートとした.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="plugin">プラグインインターフェース
-----------------------------------

Moaiプラグインでは以下のダイナミックロード可能なグローバル関数を C 言語により実装する.
このバージョンにおいてサポートされる関数は以下である.

~~~c

  bool initiate( ZnkMyf ftr_send, const char* parent_proxy, ZnkStr result_msg );

    target固有のsendフィルタの初期化処理を行う.
    Web Configurationの「Virtual USERS Initiation」ボタンを押すとこの関数が呼び出される.
    
    @param ftr_send:
     初期化対象となるフィルタへの参照である.
     pluginはこの関数内でこの値を参照および変更してかまわない.
    
    @param parent_proxy:
     Moaiが現在使用中の外部プロキシがhostname:portの形式で設定されている.
     (外部プロキシを使用していない場合はこの値が空値であるかまたはNONEであるかまたは:0が指定されている)
     pluginはこの関数内でこの値の参照は可能だが変更することはできない.
    
    @param result_msg:
     ここにはこの関数の処理をおこなった結果のメッセージを格納しなければならない.
     これは処理が成功した場合はそれをリポートメッセージであり、エラーが発生した場合はそれを示す
     エラーメッセージとなる.
     「Virtual USERS Initiation」ボタンを押すとすぐ下にこのメッセージが表示される形になる.


  bool on_post( ZnkMyf ftr_send );

    target固有のPOST直前時の処理を行う.
    POST直前に毎回呼び出される.

    @param ftr_send:
     処理対象となるフィルタへの参照である.
     pluginはこの関数内でこの値を参照および変更してかまわない.


  bool on_response_hdr( ZnkMyf ftr_send, ZnkVarpAry hdr_vars );

    target固有のレスポンスヘッダを受け取った場合における処理を行う.
    レスポンスを受け取った場合に毎回呼び出される.

    ftr_send:
    処理対象となるフィルタへの参照である.
    これがどう加工されるのかはあなたがこの関数をどう実装するかによる.

    hdr_vars:
    処理対象となるレスポンスヘッダへの参照である.
    これがどう加工されるのかはあなたがこの関数をどう実装するかによる.


  bool on_response( ZnkMyf ftr_send, ZnkVarpAry hdr_vars, ZnkStr text );

    target固有のレスポンスを受け取った場合における処理を行う.
    レスポンスを受け取った場合に毎回呼び出される.

    @param ftr_send:
     処理対象となるフィルタへの参照である.
     pluginはこの関数内でこの値を参照および変更してかまわない.
   
    @param hdr_vars:
     処理対象となるレスポンスヘッダへの参照である.
     pluginはこの関数内でこの値を参照および変更してかまわない.
   
    @param text:
     処理対象となるレスポンステキストデータへの参照である.
     pluginはこの関数内でこの値を参照および変更してかまわない.
   
    @param req_urp:
     処理対象となるURIのpath部分(URIにおけるオーソリティより後ろの部分)が渡される.
     pluginはこの関数内でこの値の参照は可能だが変更することはできない.

~~~
